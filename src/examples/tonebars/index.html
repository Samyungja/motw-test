<!doctype html>
<html>

<head>
  <title>Examples | MOTW 2015</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="../../assets/example-common.html"></script>
</head>

<body>
  <div class="example-header">
    <div class="subheading-1"><a href="../">Example</a> :</div>
    <div class="heading-1">Tone Bars</div>
    <p class="example-header-desc">
      Drag to change the tone by changing the magnitude of each sine wave. 
    </p>
  </div>

  <div class="example-main">
    <canvas id="spectrum" width="500" height="256"></canvas>
    <canvas id="waveform" width="500" height="256"></canvas>
  </div>

  <script src="fft.js"></script>
  <script>
    var order = 5;
    var length = Math.pow(2, order);

    var fft = new FFT(order);

    var context = new AudioContext();
    var osc = context.createOscillator();
    osc.connect(context.destination);
    osc.start();
    osc.frequency.value = 60;

    var spectrumCanvas = document.getElementById('spectrum');
    var spectrumCTX = spectrumCanvas.getContext('2d');

    var waveformCanvas = document.getElementById('waveform');
    var waveformCTX = waveformCanvas.getContext('2d');

    var width = 500;
    var height = 256;

    spectrumCTX.fillStyle = '#eaeaea';
    spectrumCTX.fillRect(0, 0, width, height);

    var padding = 2;
    var barWidth = width / length;

    var waveformR = new Float32Array(fft.N);
    var waveformI = new Float32Array(fft.N);

    var values = new Float32Array(length);
    var zeros = new Float32Array(length);
    for (var v = 0; v < length; v++) {
      values[v] = 0.0;
      zeros[v] = 0.0;
    }
    values[0] = 1.0;

    draw();

    function draw() {

      var yOrigin = height / 2;

      spectrumCTX.fillStyle = '#eaeaea';
      spectrumCTX.fillRect(0, 0, width, height);

      spectrumCTX.fillStyle = '#3a3a3a';
      for (var i = 0; i < length; i++) {
        var x = barWidth * i;
        var value = values[i];
        spectrumCTX.fillRect(x + padding, yOrigin, barWidth - padding * 2, yOrigin * -value);
      }

      waveformCTX.fillStyle = '#eaeaea';
      waveformCTX.fillRect(0, 0, width, height);

      waveformCTX.strokeStyle = '#3a3a3a';
      var xInterval = width / length;
      
      waveformCTX.beginPath();
      waveformCTX.moveTo(0, yOrigin);
      for (i = 0; i < waveformR.length; i++) {
        var amp = waveformR[i] * 2.0;
        waveformCTX.lineTo(i * xInterval, (1 - amp) * yOrigin);
      }
      waveformCTX.stroke();
    }


    function mapValues(event) {
      var rect = spectrumCanvas.getBoundingClientRect();
      var x = event.clientX - rect.left;
      var y = event.clientY - rect.top;
      var index = ~~(x / barWidth);
      var value = (y / height) * -2 + 1;

      // console.log(event);

      if (event.altKey)
        values[index] = 0.0;
      else
        values[index] = value;
      
      var pw = context.createPeriodicWave(values, zeros, { disableNormalization: true });
      osc.setPeriodicWave(pw);

      fft.ifft(values, zeros, waveformR, waveformI);
      fft.ifftScale(waveformR, waveformI);

      draw();
    }


    var pressed = false;

    spectrumCanvas.addEventListener('mousedown', function (event) {
      pressed = true;
      mapValues(event);
    });

    spectrumCanvas.addEventListener('mousemove', function (event) {
      if (pressed) {
        mapValues(event);
      }
    });

    spectrumCanvas.addEventListener('mouseup', function (event) {
      pressed = false;  
    });
  </script>
</body>

</html>